| 时间     | 作者 | 版本号 |
| -------- | ---- | ------ |
| 20240117 | 罗西 | V1.0.0 |
|          |      |        |
|          |      |        |



## 电机控制



### 一、电机控制基础

FOC(Filed-Oriented Control)磁场定向控制，也被称作为矢量控制（VC，Vector Control），是目前直流无刷电机（BLDC）和永磁同步电机（PMSM）高效控制的最优方法之一。

FOC旨在通过精确的控制磁场大小与方向来控制无刷电机。

优势：电机转矩平稳，噪声小，效率高，并且具有高速的动态响应。

以下探讨的是直流三相无刷电机：（BLDC直流无刷电机和PSMS用词同步电机）

无刷电机构成：无刷电机由定子和转子构成，一般的定子是固定在外圈的线圈，根据安培定则（右手定则），线圈通电后会产生磁场。转子是永磁体，根据磁性同性相斥，异性相吸的原理，当通电线圈产生旋转的的磁场去吸引中间的转子运动，这样电机就可以跟随着磁场旋转。

![三相电机原理图](images\三相电机原理图.PNG)

问题1 ：无刷电机是直流供电，如何产生周期性变化的磁场？

答：三相逆变电路。

无刷电机的驱动需要在不同时刻施加不同方向的电压（电流）。而直流电机是使用直流电压供电的，所以需要采用逆变采用逆变电路。周期性变化的电压产生周期性变化的电流，周期性变化的电流产生周期性变化的磁场，通过控制电流从不同的方向流入流出，就可以得到不同方向的磁场。

![三相电机控制图](images\三相电机控制图.PNG)

逆变电路就是把直流电变成交流电，简单来说就是一个可以产生不同电流流向的电路，通过控制Q1-Q6 mos管的开关状态来控制电流的方向。需要注意的是，逆变电路中分为上桥臂和下桥臂，Q1Q2Q3为上桥臂，Q4Q5Q6为下桥臂，Q1和Q4，Q2和Q5，Q3和Q6分别为一组，每组的上桥臂导通下桥臂关闭表示逻辑1，每组的下桥臂导通上桥臂关闭表示逻辑0，同一时刻每组最多只能有一个闭合导通，如果两个都导通，电流就不会经过绕组，会短路。对三组进行编码可以得到八种状态：

000 001 010 011 100 101 110 111（其中000 111 为0矢量，可以不用看，电路处于非导通状态）

上面八种不同的状态下会使三相绕组产生不同方向的磁场：

![逆变电路旋转磁场](images\逆变电路旋转磁场.PNG)

这样就相当于磁场在旋转，就会带着定子磁铁旋转。总的流程为 100->101->001->011->010->110->100,完成一圈的旋转。

但是这样旋转是一顿一顿的，为了让电机连续稳定的旋转，需要知道旋转时三相电机电压的波形，这里我们通过反电动势去判断，即旋转定子，切割磁场会产生电流电压，观察三相输出的电压情况。

![三相正弦电压](images\三相正弦电压.PNG)

我们发现，三相电压的波形正好是三根正弦曲线，相位差为120度。也就是说为了平稳匀速控制电机，需要输入三根正弦曲线的电压。但是使用逻辑去控制输入一个周期性变化的正弦曲线，显然不太现实，因为单片机控制电压只能是0和1，无法做到连续变化。为了解决这个问题，需要引入PWM和SVPWM。

PWM，脉宽调制技术，原理是通过调整0和1在一个周期内持续的时间来得到0和1中间的变量，通过设置占空比去进行调节。利用PWM可以实现使用离散的开关量来模拟连续的电压值。

SVPWM,空间矢量脉宽调制，原理是将周期变的很小，在这个很小的周期里去使用PWM，从而得到近似正弦波的效果。

![SVPWM原理](images\SVPWM原理.PNG)

宏观上来看，我们就是要使用SVPWM产生正弦变化的电压输入到三相逆变电路中去控制电机旋转。

![FOC宏观流程](images\FOC宏观流程.png)



### 二、空间矢量电压

空间电压矢量是我们在控制电机过程中虚拟出来的一个矢量，它是SVPWM的输入。简单理解就是电流从ABC三相流入流出时产生的整体合成的磁场矢量，这个矢量的大小和方向决定了电机该如何旋转，因为转子会尽量保证自己的磁力线的方向与外部磁场方向一致，所以转子是跟着空间电压矢量走的。

![空间电压矢量](images\空间电压矢量.PNG)

六种编码状态对应六个方向的电压矢量，在实际控制中我们需要得到任意方向的空间电压矢量才能使电机平稳的旋转，为了生成中间状态的电压矢量，就需要使用相邻两个基矢量去合成，通过作用时间的长短表示其方向。

![参考电压矢量合成](images\参考电压矢量合成.PNG)




$$
|U_{ref}|.\sin\theta = (T_6/T)U_6.\sin(2\pi/3)
$$

$$
|U_{ref}|.\sin(\pi/3) = (T_4/T).U_4.\sin(2\pi/3)
$$

$$
|U_4| = |U_6| = 2/3U_{dc}
$$

根据上面的三个公式可以求出T6和T4的作用时间：
$$
T_4 = mT\sin(\pi/3 - \theta)
$$

$$
T_6 = mT\sin\theta
$$

其中m为SVPWM的调制比系数：
$$
m = \sqrt{3}.|U_{ref}|/U_{dc}
$$
再结合零矢量，将其平滑的分布在一个周期内，由此，可以得到一个周期内的mos管编码状态和切换状态

![七段式SVPWM2](images\七段式SVPWM2.PNG)

由于PWM波形设定为中央对其方式，0矢量在其中起过渡作用，使得在每个阶段进行切换时，都只有一个相发生变化

000->100->110->111->110->100->000

中间插入了零矢量，使切换状态更加平滑，也能有效降低PWM的谐波分量，这就是七段式SVPWM调制法。

| Uref所在的位置          | 开关切换顺序                 |
| ----------------------- | ---------------------------- |
| 一区（0<theta<=60 ）    | ...0--4--6--7--7--6--4--0... |
| 二区（60<theta<=120 ）  | ...0--2--6--7--7--6--2--0... |
| 三区（120<theta<=180 ） | ...0--2--3--7--7--3--2--0... |
| 四区（180<theta<=240 ） | ...0--1--3--7--7--3--1--0... |
| 五区（240<theta<=300 ） | ...0--1--5--7--7--5--1--0... |
| 六区（300<theta<=360 ） | ...0--4--5--7--7--5--4--0... |

至此，SVPWM的工作完成了，我们得到了每一时刻所需要的空间电压矢量以及他们持续的时间，在处理器中赋值给对应的通道的捕获比较寄存器产生相应的三个PWM波形，控制MOS开关，进而产生我们期望的电压，电流，力矩。



### 三、CLARK变换和PARK变换

由于控制三相正弦波非常复杂，使用clark变换可以让控制无刷电机的三相正弦波变成变成两项正弦波。

FOC的控制流程为：

1 采集三相电流IA IB IC

2 将三相电流经过Clark变换得到两相静止坐标系下的电流  I_alpha I_beta

3 再将 I_alpha I_beta进行Park变换得到旋转坐标系下的电流 I_q I_d

4 计算I_q I_d与设定值Id_ref Iq_ref的误差

5 将误差丢入PI执行器，执行器输出Ud Uq

6 U_d U_q进行反Park变换得到U_alpha U_beta

7 最后U_alpha U_beta经过SVPWM变成作用在三相上的电压Ua Ub Uc

![FOC控制框图](images\FOC控制框图.png)
