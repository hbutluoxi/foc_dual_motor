| 时间     | 作者 | 版本号 |
| -------- | ---- | ------ |
| 20240117 | 罗西 | V1.0.0 |
| 20240122 | 罗西 | V1.0.1 |
| 20240128 | 罗西 | V1.0.2 |



## 电机控制

### 一、无刷电机

​		无刷电机由定子和转子构成，一般的定子是固定在外圈的线圈，根据安培定则（右手定则），线圈通电后会产生磁场。转子是永磁体，根据磁性同性相斥，异性相吸的原理，当通电线圈产生旋转的的磁场去吸引中间的转子运动，这样电机就可以跟随着磁场旋转。

![三相电机原理图](images\三相电机原理图.PNG)

​		目前主流的无刷电机分为两类，一类是直流无刷电机（BLDC,Brushless Direct Current Motor），一类是永磁同步电机（PMSM,Permanent Magnet Synchronous Motor）。

​		这两类电机从字面意义上并不能够完全区分这两种电机的不同，因为其实他们的机构差异不大，工作原理也基本一样，实际上我们区分这两种电机的主要依据是电机的反电动势。

![BLDC_PMSM反电动势](images\BLDC_PMSM反电动势.PNG)

​		BLDC的反电动势波形是梯形波，PMSM的反电动势是正弦波。这是他们最大的不同点，因为反电动势的不同会决定他们的控制方法不同。造成这种不同的原因是电机设计过程的关键，因为定子排布和转子磁场排布都对最终的反电动势波形产生影响。

​		无刷直流电机的结构相对比较简单，定子线圈大多采用集中式绕组结构，该结构工艺简单，成本低廉，是应用范围最广的BLDC定子结构。而永磁同步电机的定子绕组更加 “分布、均匀” ，直觉上来看PMSM运行应该更加安静、顺滑。（此处描述不一定准确）

![定子绕组](images\定子绕组.PNG)



### 二、电机控制基础

​		电机设计的不同也引出两种不同的控制方法当前主流的电机控制方法有两种，方波控制和正弦波控制。

#### 2.1 方波控制

​		方波控制也叫六步换向控制，就是根据转子的位置在360°的电气周期内，进行六次换向（每60°换向一次）。每个换向方位电机输出特定方向的力，因而可以说方波控制的位置精度是电气60°。因为在这种方法控制下，电机的相电流接近方波，所以称为方波控制。

![六步换相](images\六步换相.PNG)

#### 2.2 磁场定向控制FOC

​		正弦波控制，FOC(Filed-Oriented Control)磁场定向控制，也被称作为矢量控制（VC，Vector Control），是目前直流无刷电机（BLDC）和永磁同步电机（PMSM）高效控制的最优方法之一。

​		FOC旨在通过精确的控制磁场大小与方向来控制无刷电机。即通过高精度的角度解析，产生和转子相对静止的控制磁场，实现对PMSM的像素级控制。优势：电机转矩平稳，噪声小，效率高，并且具有高速的动态响应。



#### 2.3 三相逆变电路

​		无刷电机是直流供电，如何产生周期性变化的磁场？

​		无刷电机的驱动需要在不同时刻施加不同方向的电压（电流）。而直流电机是使用直流电压供电的，所以需要采用逆变采用逆变电路。周期性变化的电压产生周期性变化的电流，周期性变化的电流产生周期性变化的磁场，通过控制电流从不同的方向流入流出，就可以得到不同方向的磁场。

![三相电机控制图](images\三相电机控制图.PNG)

​		逆变电路就是把直流电变成交流电，简单来说就是一个可以产生不同电流流向的电路，通过控制Q1-Q6 mos管的开关状态来控制电流的方向。需要注意的是，逆变电路中分为上桥臂和下桥臂，Q1Q2Q3为上桥臂，Q4Q5Q6为下桥臂，Q1和Q4，Q2和Q5，Q3和Q6分别为一组，每组的上桥臂导通下桥臂关闭表示逻辑1，每组的下桥臂导通上桥臂关闭表示逻辑0，同一时刻每组最多只能有一个闭合导通，如果两个都导通，电流就不会经过绕组，会短路。对三组进行编码可以得到八种状态：

000 001 010 011 100 101 110 111（其中000 111 为0矢量，可以不用看，电路处于非导通状态）

​		上面八种不同的状态下会使三相绕组产生不同方向的磁场：

![逆变电路旋转磁场](images\逆变电路旋转磁场.PNG)

​		这样就相当于磁场在旋转，就会带着定子磁铁旋转。总的流程为 100->101->001->011->010->110->100,完成一圈的旋转。

​		但是这样旋转是一顿一顿的，为了让电机连续稳定的旋转，需要知道旋转时三相电机电压的波形，这里我们通过反电动势去判断，即旋转定子，切割磁场会产生电流电压，观察三相输出的电压情况。

![三相正弦电压](images\三相正弦电压.PNG)

​		我们发现，三相电压的波形正好是三根正弦曲线，相位差为120度。也就是说为了平稳匀速控制电机，需要输入三根正弦曲线的电压。但是使用逻辑去控制输入一个周期性变化的正弦曲线，显然不太现实，因为单片机控制电压只能是0和1，无法做到连续变化。为了解决这个问题，需要引入PWM和SVPWM。

PWM，脉宽调制技术，原理是通过调整0和1在一个周期内持续的时间来得到0和1中间的变量，通过设置占空比去进行调节。利用PWM可以实现使用离散的开关量来模拟连续的电压值。

SVPWM,空间矢量脉宽调制，原理是将周期变的很小，在这个很小的周期里去使用PWM，从而得到近似正弦波的效果。

![SVPWM原理](images\SVPWM原理.PNG)

宏观上来看，我们就是要使用SVPWM产生正弦变化的电压输入到三相逆变电路中去控制电机旋转。

![FOC宏观流程](images\FOC宏观流程.png)



### 三、空间矢量电压

​		空间电压矢量是我们在控制电机过程中虚拟出来的一个矢量，它是SVPWM的输入。简单理解就是电流从ABC三相流入流出时产生的整体合成的磁场矢量，这个矢量的大小和方向决定了电机该如何旋转，因为转子会尽量保证自己的磁力线的方向与外部磁场方向一致，所以转子是跟着空间电压矢量走的。

![空间电压矢量](images\空间电压矢量.PNG)

​		六种编码状态对应六个方向的电压矢量，在实际控制中我们需要得到任意方向的空间电压矢量才能使电机平稳的旋转，为了生成中间状态的电压矢量，就需要使用相邻两个基矢量去合成，通过作用时间的长短表示其方向。

![参考电压矢量合成](images\参考电压矢量合成.PNG)




$$
|U_{ref}|.\sin\theta = (T_6/T)U_6.\sin(2\pi/3)
$$

$$
|U_{ref}|.\sin(\pi/3) = (T_4/T).U_4.\sin(2\pi/3)
$$

$$
|U_4| = |U_6| = 2/3U_{dc}
$$

根据上面的三个公式可以求出T6和T4的作用时间：
$$
T_4 = mT\sin(\pi/3 - \theta)
$$

$$
T_6 = mT\sin\theta
$$

其中m为SVPWM的调制比系数：
$$
m = \sqrt{3}.|U_{ref}|/U_{dc}
$$
再结合零矢量，将其平滑的分布在一个周期内，由此，可以得到一个周期内的mos管编码状态和切换状态

![七段式SVPWM2](images\七段式SVPWM2.PNG)

由于PWM波形设定为中央对其方式，0矢量在其中起过渡作用，使得在每个阶段进行切换时，都只有一个相发生变化

000->100->110->111->110->100->000

中间插入了零矢量，使切换状态更加平滑，也能有效降低PWM的谐波分量，这就是七段式SVPWM调制法。

| $U_{ref}$所在的位置        | 开关切换顺序                 |
| -------------------------- | ---------------------------- |
| 一区（0<$\theta$<=60 ）    | ...0--4--6--7--7--6--4--0... |
| 二区（60<$\theta$<=120 ）  | ...0--2--6--7--7--6--2--0... |
| 三区（120<$\theta$<=180 ） | ...0--2--3--7--7--3--2--0... |
| 四区（180<$\theta$<=240 ） | ...0--1--3--7--7--3--1--0... |
| 五区（240<$\theta$<=300 ） | ...0--1--5--7--7--5--1--0... |
| 六区（300<$\theta$<=360 ） | ...0--4--5--7--7--5--4--0... |

至此，SVPWM的工作完成了，我们得到了每一时刻所需要的空间电压矢量以及他们持续的时间，在处理器中赋值给对应的通道的捕获比较寄存器产生相应的三个PWM波形，控制MOS开关，进而产生我们期望的电压，电流，力矩。



### 四、CLARK变换和PARK变换

由于控制三相正弦波非常复杂，使用clark变换可以让控制无刷电机的三相正弦波变成变成两项正弦波。

FOC的控制流程为：

1 采集三相电流$I_a$、$I_b$、$I_c$

2 将三相电流经过Clark变换得到两相静止坐标系下的电流 $I_\alpha$、$I_\beta$

3 再将$I_\alpha$、$I_\beta$进行Park变换得到旋转坐标系下的电流$I_q$、$I_d$

4 计算$I_q$、$I_d$与设定值$I_{d-ref}$、$I_{q-ref}$的误差

5 将误差丢入PI执行器，执行器输出$U_d$、$U_q$

6 $U_d$、$U_q$进行反Park变换得到$U_\alpha$、$U_\beta$

7 最后$U_\alpha$、$U_\beta$经过SVPWM变成作用在三相上的电压$U_a$、$U_b$、$U_c$

![FOC控制框图](images\FOC控制框图.png)

第一步：采集到三相的电流$I_a$ $I_b$ $I_c$（后面会详细介绍采集电流的方案）。

第二步：Clark变换，将三相坐标系变成两相坐标系，新的坐标系命名为$ \alpha $、$\beta$坐标系，变换公式如下：

![clark变换](images\clark变换.PNG)
$$
I_\alpha = I_a - \cos(2\pi/3)I_b - \cos(2\pi/3)I_c
$$

$$
I_\beta = \sin(2\pi/3)I_b - \sin(2\pi/3)I_c
$$

写成矩阵形式就是：
$$
\left[\begin{matrix}
I_\alpha\\
I_\beta
\end{matrix}\right] =\left[\begin{matrix}
1 & -\frac{1}{2} & -\frac{1}{2}\\
0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2}
\end{matrix}\right] \left[\begin{matrix}
I_a \\ I_b \\ I_c
\end{matrix}\right]
$$
经过Clark变换后，我们需要控制的三条正弦波变成了两条。

![clark变换过程](images\clark变换过程.PNG)

第三步：Park变换，将两相坐标系$I_\alpha$、$I_\beta$变换成旋转坐标系$I_d$、$I_q$，变换公式如下：



![park变换2](images\park变换2.PNG)
$$
I_d = I_\alpha\cos\theta + I_\beta\sin\theta
$$

$$
I_q = -I_\alpha\sin\theta + I_\beta\cos\theta
$$

写成矩阵形式就是：
$$
\left[\begin{matrix}
I_d\\
I_q
\end{matrix}\right] =\left[\begin{matrix}
\cos\theta & \sin\theta\\
-\sin\theta & \cos\theta
\end{matrix}\right] \left[\begin{matrix}
I\alpha\\
I_\beta
\end{matrix}\right]
$$
其中$I_q$是切向的电流，代表了期望的力矩输出，$I_d$是径向的电流，我们希望尽可能把它控制为零。

根据物理结构，$d$轴方向与转子磁链方向重合，又叫直轴，$q$轴方向与转子磁链方向垂直，又叫交轴，如图：

![d_q轴](images\d_q轴.PNG)

经过Park变换后，将两相的正弦量变成了容易控制的直线量。

![park变换过程](images\park变换过程.PNG)

经过Clark变换和Park变换，我们将一个三相的正弦量变成了一个单相的直线量。

![clark_park2](images\clark_park2.PNG)

到这里，可以说将电机控制的原理讲的比较清楚了，后面的几步就是跟实际控制相关的了，也就是在实际工程中如何去使用和应用了。



### 五、电机控制问题

#### 5.1 电流采样问题

​		在实际的电机控制中，需要得到三相的电流去进行控制，就会涉及电流采样的问题，即如何获取每项的电流，一般会使用高精度采样电阻和运放搭配使用，一路运放配一个采样电阻就可以一相的电流。

​		第一种最简单的方案就是三电阻采样法，在三相上都设计采样电阻，同一时刻采集三相的电流即可。这样做比较简单，但是硬件成本相对来说会高一些。因为高精度采样电阻和运放器件都是成本。

![三电阻采样](images\三电阻采样.PNG)

​		第二种方法是双电阻采样，在硬件电路设计中，可以设计双电阻采样，比如同一时刻采集A相和B相的电流，根据根据基尔霍夫电流定律，在任意瞬间，同一节点流进和流出的电流相等，用数学表达式就是：
$$
I_a+I_b+I_c=0
$$
已知采样到两相电流，由上面的公式可以计算出C相的电流。

![双电阻采样](images\双电阻采样.PNG)

​		双电阻硬件电路的设计，即采样电阻的位置跟采样的时刻是有关系的，如上图的设计，V000矢量作用时三相上桥臂截止，电流流经下桥臂，此时采样可得到准确的电流。前半段和后半段皆可。



​		第三种方法就是单电阻采样，硬件上只设计一个采样电阻，只采集母线电流，如图：

![单电阻采样](images\单电阻采样.PNG)

​		硬件上只有一个采样电阻，但是为了得到三相的电流，需要在一个周期内采集两次电流，然后计算得到三相的电流，继而进行后面的计算。单电阻采样方案成本最低，但是在控制上要求会高一些。因为要想在一个周期内获取到两相的电流，在一些特定的情况下是比较难的。甚至于在某些条件下无法采集到两相电流。

![采样时刻对应的相电流表](images\采样时刻对应的相电流表.PNG)

如上图，0表示下桥臂关，上桥臂开，$V_1$状态下，$T_1$闭合，$T_4$打开，母线上采集到的就是$I_a$。根据中央对其方式，可以得到在一个PWM周期内的电流图（中央对其方式只能看到两相电流？）：

![单电阻采样电流图](images\单电阻采样电流图.PNG)

但是这样同样会有问题

1 当两相极大一项极小或者两相极小一相极大时，只能采集到一相电流。

![单电阻采样问题1两大一小两小一大](images\单电阻采样问题1两大一小两小一大.PNG)

![两大一小两小一大](images\两大一小两小一大.PNG)

这两种情况下没有足够采样窜口去采样第二项电流。

2 调制比比较小的时候，实际表现为低转速低负载的情况下，没有办法采集到对应的电流。

![单电阻采样三小](images\单电阻采样三小.PNG)

在解决这两个问题之前，我们先提出几个概念

1、$T_{rise}$表示mos管导通到稳定的时间，这个跟硬件设计和元器件相关。

![Trise](images\Trise.PNG)

2、Sampling Time 采样周期，这个时间跟控制器本身外设的性能有关的。

3、Dead Time 截至时间，需要预留时间给开关mos管的时间。

4、$D_{min}$表示最小的采样窗口时间。
$$
D_{min} =$T_{rise}$+Sampling Time +Dead Time
$$
总的来说，单电阻采样时会有以下四种状态;

![单电阻采样四种情况](images\单电阻采样四种情况.PNG)

我们知道了边界采样问题的存在

常规的解决方案，也就是目前使用比较多的一种方案，移相法。

![单电阻采样解决移相法](images\单电阻采样解决移相法.PNG)

移相移动出采样窗口，使采样电阻能采样到两相的电流，但是这种情况下会对占空比有损失。



第二种方案，挖槽法

![单电阻采样解决挖槽法](images\单电阻采样解决挖槽法.PNG)

挖槽法与移相法原理相似，都是需要创造出采样的窗口。



#### 5.2 位置估计问题

​		为了实现foc闭环的控制，在控制框图的下半部分是需要知道转子的实时角度信息的，因此电机转子的实时位置获取也是电机控制中的一个关键的地方，由此也引申出来两种控制方法，有感控制和无感控制。

**有感**就是表示电机带有位置传感器，比如霍尔传感器或者编码器等。

1.位置编码器：通过高精度的光栅感应定子旋转过程中引起的数字编码变化，从而解算出转子位置信息，一般引用在高精度的私服系统中。

2.霍尔磁编码器：通过在电机轴的端部安装的永磁体旋转，引起霍尔传感器的磁感线变化，从而解算出准字位置信息，一般应用在中小功率泵类驱动系统中。

3.旋转变压器：电机轴的旋转引起旋转变压器感应电压的变化，通过一定的解码算法，从而解算转子位置信息，一般应用在高可靠性、高寿命的电动汽车系统中。

4.观测器位置算法：这是一种无位置传感器的方法，通过电机模型的建模计算出反电动势的变化，从而解析出转子的位置信息，该方法可靠性高，成本低，维护方便，也是电机控制最火热的方向。笔者认为，该方案主要取代的是Hall编码器的应用市场，对于高精度，高可靠性，快速动态性能的场合应用还是比较有限。

**无感**就是指没有任何外界传感器的情况下去估计和观察到转子的位置。

有感控制相对来说就简单一些，因为能实时知道电机转子的位置。而无感控制就需要间接的去获取电机转子的位置，常见的无感控制方法有磁链法、滑膜法、龙克伯格观测器，高频注入等。下面将一一介绍这几种方法。

#### 5.3 无感方波控制

​		无感方波控制，没有传感器，实际是使用无刷电机线圈作为传感器，方波控制也叫六步驱动，他的特点是在电机旋转的任何时刻，三个电机端子一个接电源正极，一个接电源地，一个浮空，这样在浮空端子上就能检测到电机线圈的反电动势，当永磁体经过线圈时，反电动势会出现由正转负或由负转正的变化，就是所谓的反电动势过零点，它刚好与线圈对其，是一个固定的参考位置，基于三个电机端子节点组网络形成的虚拟中性点，单片机就可以通过比较器对浮空相电压与虚拟中性点电压进行比较，根据比较器的翻转确定过零点，进而根据先前的换相时间推算出下一步换相的时刻，就实现了电机的连续运转，考虑到反电动势与电机转速成正比，当点击静止时，反电动势为零，无法检测过零点，当电机转速过低时，反电动势太小，信噪比过低，无法准确检测过零点，也就是说可靠的过零点检测由最低转速要求，一般来说，无感方波启动算法实质上都是盲启，即启动时不知道电机转子的位置，而是直接用默认的换相状态驱动，尝试检测过零点，如果在默认时间内没有检测到对应的过零点，那就按照下一个换相状态驱动并检测过零点，直至检测到合适的过零点，电机正常驱动，由此可见，有的论文说电机静止时放电动势为零，无法检测过零点，所以无法启动，并非完全正确。解决方案是使用高频注入法或者磁编码器。无感方波控制还有一种不使用反电动势二使用磁链信号的方法，一般做法是先对浮空相反电动势信号进行积分得到磁链信号，然后比较磁链信号与设定阈值，决定换相时机，两种方法的区别在于，反电动势过零点信号与换相点信号不一致，对零度近角来说有30°偏移，也就是检查到零点后，要再过30°电角才能换相，二磁链信号与换相点信号是一致的，可以方便的调节换相近角，比使用反电动势过零信号的方法响应更快，更可靠。

​		在六步驱动中，总有一个电机端子是浮空的，此相半桥的功率开关管截止，阻抗无限大，所以可以采集这个端子的反电动势过零点为换相依据。过零点位置每60°跳跃一次，六次换相总计360度角.

#### 5.4 无感FOC控制

​		无感FOC的情况完全不同，每一相的上下桥功率开关管都是使用互补PWM驱动的，端子要么为电源电压，要么接地，没有浮空相，因此无法检测过零点信号，既然无法直接检测，那就只能使用间接方法，由此产生两类位置估计算法。

​		无感FOC控制需要的是连续的位置信号，第一类是由反电动势或者磁链信号得到位置信息，是主流方法，性能良好，但很难在低速或者静止状态下持续跟踪信号，优秀的设计可以实现速度过零的连续跟踪，在快速反转的情况下也能正常工作，具体策略由三种，第一种是间接得到反电动势信号，思路是构建一个电机数学模型，与真实的电机一起运行，对于同样的电压输入，理论上真实电机的电流应该和电机模型的电流一致，但实际中必然有所差异，于是用控制器加以补偿，一旦电机模型和真实电机的电流相同，就认为补偿结束，这时就可以对补偿量滤波，得到反电动势，进而对两相正交坐标系中的两个反电动势信号做反正切运算，解算出连续的位置信号。参见《Microchip AN1078应用笔记》

​		第二种也基于反电动势信号，但是与第一种不同，它根据电机稳态运行时，平行与磁体方向（d轴）的反电动势为0这个事实，通过锁相环控制其始终为0，这样就可以通过检测d轴反电动势是否为0来调节给定速度，进而对速度积分，即在每个控制周期对速度值进行累加得到位置信息，这个位置信息又决定了d轴反电动势是否为0，，如此构成闭环控制。

​		第三种不使用反电动势信号，而是使用磁链信号，对于磁链信号，共有三种解算方法，第一种方法是对两相正交的磁链信号求反正切，直接得到位置。第二种方法是利用外插法通过锁相环得到位置，基于锁相环的控制一般都比较稳定，位置信号比较平滑，低速特性比较好，适合那红转速不高的应用，如滚筒洗衣机的那种直接驱动型外转子无刷电机，其最大的问题是，一旦堵转，就会出现失步，不适合高动态响应需求。第三种方法是直接估算三相禁止坐标系中的转子磁链，但考虑到速度变化时很难进行相位误差补偿，用的不多，实际工程应用以前两种为主。

​		第二类位置估计算法其实就是高频注入算法，它利用电机的dq轴电感差异来检测位置，最大的优势是支持零速跟中位置，结合脉冲定位的方式，可以做到完全无反转，平滑顺畅的快速启动，其缺点是由高频噪声，响度比较大，尽管提高PWM频率，随机抖动占空比，随机改变PWM频率，或者提高采样激励频率，可将噪声提高到听阈以外，但难免由谐波成分被人耳感知，然而实施高频注入的前提是电机制造上保证dq轴电感存在差异。需要通过磁链信号和高频注入相结合才能实现全速域控制。

5.5 BLDC的类FOC控制

​		在小电机的应用中，BLDC越来越广泛，对其要控制要求也是越来越高： 既要低成本，也要静谧性！我们知道Six-Step的转矩脉动很大，电机功率小的应用还能忍受，电机功率稍微到几百瓦这个量级，噪音成为了产品的短板！因此，很多厂家也推出了类FOC的控制方案去控制BLDC，这类方案在 不增加系统成本得前提下 ，使BLDC运行的更安静！

​		所谓类FOC，其实最主要的就是我们把BLDC的角度进行更细的划分，那么这个更细角度主要是靠：猜！通过反电动势检测，我们能够检测出60°的反电动势换向点，那么在这个60°之间的角度，就要根据电机的运行速度和状态去插值，从而产生类似的平稳的“ 定向磁场 ”。

​		现在还有一个问题，就是三相都参与调制的情况下如何检测反电动势换向点？可以采用低成本数字Hall芯片进行磁钢位置检测，也可以通过驱动的适当控制，检测反电动换向点，是ELMOS所采用的一种的算法：就是在死区时间段内，检测相电压信号，从而获得相电流的方向信息，进而找出相电流的过零点。 **从相电流推断反电动势过零点 ，可以预见该方法的环路响应是比较慢的。

![反电动势](images\反电动势.PNG)
